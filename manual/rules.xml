<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbook.rng" type="xml"?>
<!-- # $Id$ -->
<section 
    xml:id="RulesSection" 
    xmlns="http://docbook.org/ns/docbook" 
    version="5.0"
    xmlns:xlink="http://www.w3.org/1999/xlink" 
    xmlns:xi="http://www.w3.org/2001/XInclude"
  >
    <title>Rules for Storing Data in NeXus Files</title>
    <para>
    </para>
      <sect1>
      <title>Rules for Structuring Files</title>
      <para>
       All NeXus files contain one to many groups of type NXentry at root level.
       Many files contain only one group, then the name is entry. NXentry class 
       groups can contain raw data or processed data. If an instrument performs 
       multiple experiments simultaneously, then the data from the separate 
       sub experiments has to go in separate entries in the file. 
      </para>
        <sect2>
        <title>Content of a raw data NXentry group</title>
        <para>
           A NXentry describing raw data contains at least a NXsample, one NXmonitor, 
           one NXdata and a NXinstrument group. It is good practice to use the names 
           sample for the NXsample group, control for the NXmonitor group holding the 
           experiment controlling monitor and instrument for the NXinstrument group. 
           The NXinstrument group contains further groups describing the individual 
           components of the instrument as appropriate. 
        </para>
        <para>
           The NXdata group contains links to all those data items in the NXentry 
           hierarchy which are required to put up a default plot of the data. If there 
           is only one such group it is good practice to name it data. Else the name 
           of the detector bank represented is a good selection. As an example consider 
           a SAX instrument with a 2D detector. The NXdata will then hold a link to 
           the detector image.  
        </para>
        </sect2>
        <sect2>
        <title>Content of a processed data NXentry group</title>
        <para>
           Process data in this context means the results of a data reduction or 
           data analysis program. NeXus stores such data in a simplified 
           NXentry structure. A processed data NXentry has at minimum a NXsample, 
           a NXdata and a NXprocess group. Again the preferred name for the NXsample 
           group is sample. In the case of processed data, the NXdata group holds the 
           result of the processing together with the associated axis data. The NXprocess 
           group holds the name and version of the program used for this processing 
           step and further NXparameter groups. These groups ought to contain the 
           parameters used for this data processing step. In suitable detail so that 
           the processing step can be reproduced. 
        </para>
        <para>
           Optionally a processed data NXentry can hold a NXinstrument group with 
           further groups holding relevant information about the instrument. The 
           preferred name is again instrument. Whereas for a raw data file, NeXus 
           strives to capture as much data as possible, a NXinstrument group for 
           processed data may contain a much reduced subset. 
        </para>         
        </sect2>
    </sect1>
    <sect1>
    <title>Rules for Storing Data Items</title>
    <para>
       These rules apply for storing individual data items in a NeXus file.
    </para>
      <sect2>
        <title>Names</title>
        <para>
          For all data fields names from the NeXus base class dictionaries are to 
          be used. If a data field name or even a complete component is missing, 
          please suggest the addition to the NIAC. The addition will usually be 
          accepted provided it is no duplication of an existing field and 
          adequatly documentd. 
        </para>
      </sect2>
      <sect2>
      <title>Units</title>
      <para>
        Given the plethora of possible applications of NeXus, it is difficult to 
        define units to use. Therefore the general rule is that you are free to 
        store data in any unit you find fit. However, any data field must have a 
        units attribute which describes the units used in the format used by the 
        udunits unit conversion program. Whereever possible, SI units are to be
        preferred. Application definitions may specify units to be used for fields.
      </para>
      </sect2>
      <sect2>
      <title>Associating Data with Axis</title>
      <para>
         In order to allow automatic plotting programs to locate the relevant signal 
         data and the axis of a possibly multi diemsnional dataset, a set of rules 
         has to be adhered too. The first one is that the data and its 
         associated axis data sets have to be in the same NeXus group. The second one is 
         that the actual main data field (usually the detector counts) has to be annotated 
         with the attribute signal=1. The axis belonging to this dataset have to be 
         annotated with the attribute axis=n, where n is the number of the dimension this 
         axis corresponds too. 
      </para>
      <para>
       An example is in order. Consider a detector bank with detectors at different 
       two theta and with a time-of-flight axis. This then is stored as:
        <simplelist>
           <member>
              A data field of dimensions ndet,ntof. With ndet being the number of 
              detectors and ntof the number of time channels. This dataset is annotated 
              with the attribute signal=1
           </member>
           <member>
             A data field polar_angle with ndet elements and the attribute axis=1
           </member>
           <member>
             A data field time_binning with ntof elements and the attribute axis=2
           </member>
        </simplelist>
      </para>
      <para>
        In some case it is desirable to have muliple axis on the same dimension. 
A        In the example above, the time_binning axis may also be expressed as d or 
        energy difference. All these axis will then have the attribute axis=2. 
        However, the primary plotting axis must be distingusihed with the 
        attribute primary=1.   
      </para>
      </sect2>
      <sect2>
      <title>Storing Detectors</title>
      <para>
         There are very different types of detectors out there. Storing their data 
         can be a challenge. As a general guide line: if the detector has some 
         well defined form, this should be reflected in the data file. A linear 
         detector becomes a linear array, a rectangular detector becomes an 
         array of size xsize times ysize. Some detectors are so irregular that this 
         does not work. Then the detector data is stored as a linear array, with the
         index being detector number till ndet. Such detectors must be accompanied
         by further arrays of length ndet which give azimuthal_angle, polar_angle 
         and distance for each detector. 
      </para>
      <para>
         If data from a time of flight (TOF) instrument must be described, then the 
         TOF dimension becomes the last dimension, for example an area detector of 
         xsize versus ysize is stored with TOF as an array with dimensions xsize, ysize, 
         ntof.  
      </para>
      </sect2>
    </sect1>
    <sect1>
    <title>Rules for Special Cases</title>
      <sect2>
      <title>Scans</title>
      <para>
         Scans are difficult to capture because they are very variable. Basically 
         any variable can be scanned. NeXus solves this difficulty with a set of 
         rules. In this section, NP is used as a symbol for the number of scan 
         points.
         <simplelist>
            <member>
              The scan dimension NP is always the first dimension of any multi 
              dimensional dataset. The reason for this is that HDF allows the first 
              dimension of a dataset to be unlimited. Which means, that data can be 
              appended to the dataset during the scan. 
            </member>
            <member>
              All data is stored as arrays of dimensions NP, original dimensions 
              of the data at the appropriate position in the NXentry hierarchy.
            </member>
            <member>
               The NXdata group has to contain links to all variables varied during 
               the scan and the detector data. Thus the NXdata group  mimics the usual 
               tabular representation of a scan.
            </member>
         </simplelist>
      </para>
      <para>
         Examples may be in order here. Let us start with a simple case, the sample is 
         rotated arounds its rotation axis and data is collected in a single tube 
         detector. Then we have:
         <simplelist>
           <member>
             A dataset at NXentry/NXinstrument/NXdetector/data of length NP containing 
             the count data.
           </member>
           <member>
             A dataset at NXentry/NXsample/rotation_angle of length NP containing 
             the positions of rotation_angle at the various steps of the scan.  
           </member>
           <member>
             NXdata contains links to NXentry/NXinstrument/NXdetector/data and 
             NXentry/NXsample/rotation_angle. The datasets in NXdata must have the 
             appropriate attributes as described in the axis location section.
           </member>
           <member>
             All other data fields have their normal dimensions.
           </member>
         </simplelist>
          The next example is the same scan but with an area detector with xsize 
          times ysize pixels. The only thing which changes is that
          NXentry/NXinsrument/NXdetector/data will have the dimensions NP, xsize, ysize.
      </para>
      <para>
          The next example involves a complex movement along an axis in reciprocal 
          space which requires mutiple motors of a four circle diffractometer to be 
          varied during the scan. We then have:
         <simplelist>
           <member>
             A dataset at NXentry/NXinstrument/NXdetector/data of length NP containing 
             the count data.
           </member>
           <member>
             A dataset at NXentry/NXinstrument/NXdetector/polar_angle of length 
             NP containing 
             the positions of the detectors polar_angle at the various steps 
             of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/rotation_angle of length NP containing 
             the positions of rotation_angle at the various steps of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/chi of length NP containing 
             the positions of chi at the various steps of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/phi of length NP containing 
             the positions of phi at the various steps of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/h of length NP containing 
             the positions of the reciprocal coordinate h at the 
             various steps of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/k of length NP containing 
             the positions of the reciprocal coordinate k at the 
             various steps of the scan.  
           </member>
           <member>
             A dataset at NXentry/NXsample/l of length NP containing 
             the positions of the reciprocal coordinate l at the 
             various steps of the scan.  
           </member>
           <member>
             NXdata contains links to NXentry/NXinstrument/NXdetector/data, 
             NXentry/NXinstrument/NXdetector/polar_angle, NXentry/NXsample/rotation_angle, 
             NXentry/NXsample/chi, NXentry/NXsample/phi, NXentry/NXsample/h, 
             NXentry/NXsample/k and NXentry/NXsample/l 
             The datasets in NXdata must have the 
             appropriate attributes as described in the axis location section.
           </member>
           <member>
             All other data fields have their normal dimensions.
           </member>
         </simplelist>
      </para>
      </sect2>
      <sect2>
      <title>Rastering</title>
      <para>
        Rastering is the process of making experiments at various locations in the 
        sample volume. Again rasterisation experiments can be variable. Some people 
        even raster on spirals! Rasterisation experiments are treated the same way as 
        describe above for scans. Just replace NP with P, the number of raster points.
      </para>
      <para>
        Special rules apply if a rasterisation happens on a regular grid of size 
        xraster, yraster. Then the variables varied in the rasterisation will be 
        of dimensions xraster, yraster and the detector data of dimensions xraster, 
        yraster, orginal dimensions of the detector. For example, an area detector of 
        size xsize, ysize then is stored with dimensions xraster, yraster, xsize, 
        ysize. (Comment by Mark: this sucks if the experiment is aborted on the fly or 
        dimensions changed on the way, shall I kill this rule?) 
      </para>
      </sect2>
    </sect1>
</section>
