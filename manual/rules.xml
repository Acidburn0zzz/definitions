<?xml version="1.0" encoding="UTF-8"?>
<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbook.rng" type="xml"?>
<!-- # $Id$ -->
<section 
    xml:id="RulesSection" 
    xmlns="http://docbook.org/ns/docbook" 
    version="5.0"
    xmlns:xlink="http://www.w3.org/1999/xlink" 
    xmlns:xi="http://www.w3.org/2001/XInclude"
  >
    <title>Rules for Storing Data in NeXus Files</title>
    <para>
    </para>
  <section>
      <title>Rules for Structuring Files</title>
    <para>
      <indexterm>
        <primary>rules</primary>
        <secondary>NeXus</secondary>
      </indexterm>
       All NeXus files contain one or many groups of type <code>NXentry</code> at root level.
       Many files contain only one 
       <code>NXentry</code>
       group, then the name is <code>entry</code>.
       If an instrument performs 
       multiple experiments simultaneously, then the data from the separate 
       component experiments must be placed in separate <code>NXentry</code>
        groups in the file. 
       Also, <code>NXentry</code> class 
       groups can contain raw data or processed data. 
        For files with more than one <code>NXentry</code> group, since HDF requires
        that no two items at the same level in an HDF file may have the same name,
        the NeXus fashion is to
        assign names with an incrementing index appended, such as 
        <code>entry1</code>, <code>entry2</code>, <code>entry3</code>, etc.
      <indexterm>
        <primary>rules</primary>
        <secondary>naming</secondary>
      </indexterm>
      </para>
    <section>
      <title>Content of a raw data <code>NXentry</code> group</title>
        <para>
          An <code>NXentry</code> describing raw data contains at least a <code>NXsample</code>, 
          one <code>NXmonitor</code>, 
          one <code>NXdata</code> and a <code>NXinstrument</code> group. 
          It is good practice to use the names 
          <code>sample</code> for the <code>NXsample</code> group, 
          <code>control</code> for the <code>NXmonitor</code> group holding the 
           experiment controlling monitor and 
           <code>instrument</code> for the <code>NXinstrument</code> group. 
          The <code>NXinstrument</code> group contains further groups describing the individual 
           components of the instrument as appropriate. 
        </para>
        <para>
          The <code>NXdata</code> group contains links to all those data 
          items in the <code>NXentry</code> hierarchy
          <indexterm>
            <primary>hierarchy</primary>
          </indexterm> 
          which are required to put up a default plot of the data.  
           As an example consider 
           a SAXS instrument with a 2D detector. 
           The <code>NXdata</code> will then hold a link to 
           the detector image.  
           If there is only one <code>NXdata</code> group,
           it is good practice to name it <code>data</code>. 
           Otherwise, the name 
           of the detector bank represented is a good selection.
        </para>
        </section>
    <section>
      <title>Content of a processed data <code>NXentry</code> group</title>
        <para>
           Processed data in this context means the results of a data reduction or 
           data analysis program. NeXus stores such data in a simplified 
          <code>NXentry</code> structure. A processed data <code>NXentry</code>
          has at minimum a <code>NXsample</code>, 
          a <code>NXdata</code> and a <code>NXprocess</code> group. 
          Again the preferred name for the <code>NXsample</code> 
           group is <code>sample</code>. 
           In the case of processed data, the <code>NXdata</code> group holds the 
           result of the processing together with the associated axis data. 
           The <code>NXprocess</code> 
           group holds the name and version of the program used for this processing 
           step and further <code>NXparameter</code> groups. These groups ought to contain the 
           parameters used for this data processing step in suitable detail so that 
           the processing step can be reproduced. 
        </para>
        <para>
          Optionally a processed data <code>NXentry</code> 
          can hold a <code>NXinstrument</code> group with 
           further groups holding relevant information about the instrument. The 
           preferred name is again <code>instrument</code>. Whereas for a raw data file, NeXus 
           strives to capture as much data as possible, a <code>NXinstrument</code> group for 
           processed data may contain a much-reduced subset. 
        </para>         
        </section>
    </section>
  <section>
    <title>Rules for Storing Data Items</title>
    <para>
      These rules apply for storing individual data items in a NeXus file.
      <indexterm>
        <primary>rules</primary>
        <secondary>NeXus</secondary>
      </indexterm>
    </para>
    <section>
        <title>Names</title>
        <para>
          For all data fields, only names from the NeXus base class dictionaries are to 
          be used.<footnote><para>The NeXus base classes provide a comprehensive dictionary
          of terms than can be used for each class.</para></footnote>
          If a data field name or even a complete component is missing, 
          please suggest the addition to the NIAC. The addition will usually be 
          accepted provided it is not a duplication of an existing field and 
          adequately documented. 
        </para>
      </section>
    <section>
      <title>Associating Data with Axis</title>
      <para>
        In order to allow automatic plotting programs
        <indexterm>
          <primary>NeXus basic motivation</primary>
          <secondary>default plot</secondary>
        </indexterm>
         to locate the relevant signal 
         data and the axis of a possibly multi-dimensional dataset, the
         data must conform with a set of rules.
        <indexterm>
          <primary>rules</primary>
          <secondary>NeXus</secondary>
        </indexterm> 
        <itemizedlist>
          <listitem><para>The first rule is that the data and its 
         associated axis data sets have to be in the same NeXus group.</para></listitem>
          <listitem><para>The second rule is 
         that the actual main data field (usually the detector counts) has to be annotated 
         with the attribute <code>signal="1"</code>. The axis belonging to this dataset have to be 
         annotated with the attribute <code>axis=n</code>, 
        where <code>n</code> is the number of the dimension to which this 
         axis corresponds. </para></listitem>
        </itemizedlist>
      </para>
      <para>
       An example is in order. Consider a detector bank with detectors at different 
       two theta and with a time-of-flight axis. This data is stored as:
        <itemizedlist>
          <listitem>
            <para>
             A data field of dimensions <code>ndet,ntof</code>. With <code>ndet</code> being the number of 
             detectors and <code>ntof</code> the number of time channels. This dataset is annotated 
             with the attribute <code>signal=1</code>              
            </para>
          </listitem>
          <listitem>
            <para>
             A data field polar_angle with <code>ndet</code> elements and the 
             attribute <code>axis=1</code>              
            </para>
          </listitem>
          <listitem>
            <para>
             A data field time_binning with <code>ntof</code> elements and the
             attribute <code>axis=2</code>
            </para>
          </listitem>
       </itemizedlist>
      </para>
      <para>
        In some case it is desirable to have muliple axis on the same dimension. 
        In the example above, the time_binning axis may also be 
        expressed as <emphasis>d</emphasis> or
        energy difference. All these axes will then have the attribute <code>axis=2</code>. 
        However, the primary plotting axis must be distingusihed with the 
        attribute <code>primary=1</code>.   
      </para>
      </section>
    <section>
      <title>Storing Detectors</title>
      <para>
         There are very different types of detectors out there. Storing their data 
         can be a challenge. As a general guide line: if the detector has some 
         well defined form, this should be reflected in the data file. A linear 
         detector becomes a linear array, a rectangular detector becomes an 
         array of size <code>xsize</code> times <code>ysize</code>. 
        Some detectors are so irregular that this 
         does not work. Then the detector data is stored as a linear array, with the
         index being detector number till <code>ndet</code>. Such detectors must be accompanied
        by further arrays of length <code>ndet</code> which give 
        <code>azimuthal_angle, polar_angle and distance</code> for each detector. 
      </para>
      <para>
         If data from a time of flight (TOF) instrument must be described, then the 
         TOF dimension becomes the last dimension, for example an area detector of 
        <code>xsize</code> <emphasis>vs.</emphasis> <code>ysize</code> 
        is stored with TOF as an array with dimensions 
        <code>xsize, ysize, 
         ntof</code>.  
      </para>
      </section>
    <section>
      <title>Monitors are Special</title>
        <para>Monitors
            <indexterm>
                <primary>monitor</primary>
            </indexterm>
            , detectors that measure the properties of the experimental probe rather than the 
            sample, have a special place in NeXus files. Monitors are crucial to normalize data.
            To emphasize their role, monitors are not stored in the 
            <code>NXinstrument</code> hierarchy but on <code>NXentry</code> level 
            in their own groups as there might be multiple monitors. Of special 
            importance is the monitor in a group called <code>control</code>. 
            This is the main monitor against which the data has to be normalized. 
            This group also contains the counting control information, 
            i.e. counting mode, times, etc.
        </para>
        <para>
          Monitor data may be multidimensional. Good examples are scan monitors 
          where a monitor value per scan point is expected or 
          time-of-flight monitors.
        </para>
    </section>
   </section>
  <section>
    <title>Rules for Special Cases</title>
    <para>Always, there are exceptions to rules
      <indexterm>
        <primary>rules</primary>
        <secondary>NeXus</secondary>
      </indexterm> 
      to consider special cases.</para>
    <section>
      <title>Scans</title>
      <para>
         Scans are difficult to capture because they are very variable. Basically 
         any variable can be scanned. NeXus solves this difficulty with a set of 
         rules. In this section, <code>NP</code> is used as a symbol for the number of scan 
         points.
        <itemizedlist>
          <listitem>
            <para>
              The scan dimension <code>NP</code> is always the first dimension of any 
              multi-dimensional dataset. The reason for this is that HDF allows the first 
              dimension of a dataset to be unlimited. Which means, that data can be 
              appended to the dataset during the scan. 
            </para>
          </listitem>
          <listitem>
            <para>
              All data is stored as arrays of dimensions <code>NP</code>, original dimensions 
              of the data at the appropriate position in the <code>NXentry</code> hierarchy.
              <indexterm>
                <primary>hierarchy</primary>
              </indexterm>
            </para>
          </listitem>
          <listitem>
            <para>
              The <code>NXdata</code> group has to contain links to all variables varied during 
               the scan and the detector data. Thus the <code>NXdata</code> group  mimics the usual 
               tabular representation of a scan.
            </para>
          </listitem>
         </itemizedlist>
      </para>
      <para>
         Examples may be in order here. Let us start with a simple case, the sample is 
         rotated arounds its rotation axis and data is collected in a single tube 
         detector. Then we have:
        <itemizedlist>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXinstrument/NXdetector/data</code> 
              of length <code>NP</code> containing 
              the count data.
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/rotation_angle</code> 
              of length <code>NP</code> containing 
              the positions of <code>rotation_angle</code> at the various steps of the scan.
            </para>
          </listitem>
          <listitem>
            <para>
              <code>NXdata</code> contains links to 
              <code>NXentry/NXinstrument/NXdetector/data</code> and 
              <code>NXentry/NXsample/rotation_angle</code>. The datasets in 
              <code>NXdata</code> must have the 
              appropriate attributes as described in the axis location section.
            </para>
          </listitem>
          <listitem>
            <para>
             All other data fields have their normal dimensions.
            </para>
          </listitem>
        </itemizedlist>
        The next example is the same scan but with an area detector with <code>xsize</code> 
        times <code>ysize</code> pixels. The only thing which changes is that
        <code>NXentry/NXinsrument/NXdetector/data</code> will have the dimensions 
        <code>NP, xsize, ysize</code>.
      </para>
      <para>
          The next example involves a complex movement along an axis in reciprocal 
          space which requires mutiple motors of a four circle diffractometer to be 
          varied during the scan. We then have:
        <itemizedlist>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXinstrument/NXdetector/data</code> of length 
              <code>NP</code> containing 
              the count data.
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXinstrument/NXdetector/polar_angle</code> of length 
              <code>NP</code> containing 
              the positions of the detector's polar_angle at the various steps 
              of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/rotation_angle</code> of length 
              <code>NP</code> containing 
              the positions of <code>rotation_angle</code> at the various steps of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/chi</code> of length <code>NP</code> containing 
              the positions of chi at the various steps of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/phi</code> of length <code>NP</code> containing 
              the positions of phi at the various steps of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/h</code> of length <code>NP</code> containing 
              the positions of the reciprocal coordinate <code>h</code> at the 
              various steps of the scan.
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/k</code> of length <code>NP</code> containing 
              the positions of the reciprocal coordinate <code>k</code> at the 
              various steps of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              A dataset at <code>NXentry/NXsample/l</code> of length <code>NP</code> containing 
              the positions of the reciprocal coordinate <code>l</code> at the 
              various steps of the scan.  
            </para>
          </listitem>
          <listitem>
            <para>
              <code>NXdata</code>  contains links to 
              <code>NXentry/NXinstrument/NXdetector/data</code>, 
              <code>NXentry/NXinstrument/NXdetector/polar_angle</code>, 
              <code>NXentry/NXsample/rotation_angle</code>, 
              <code>NXentry/NXsample/chi</code>, 
              <code>NXentry/NXsample/phi</code>, 
              <code>NXentry/NXsample/h</code>, 
              <code>NXentry/NXsample/k</code> and 
              <code>NXentry/NXsample/l </code>
              The datasets in <code>NXdata</code> must have the 
              appropriate attributes as described in the axis location section.
            </para>
          </listitem>
          <listitem>
            <para>
              All other data fields have their normal dimensions.
            </para>
          </listitem>
        </itemizedlist>
      </para>
      </section>
    <section>
      <title>Rastering</title>
      <para>
        Rastering is the process of making experiments at various locations in the 
        sample volume. Again, rasterisation experiments can be variable. Some people 
        even raster on spirals! Rasterisation experiments are treated the same way as 
        described above for scans. Just replace <code>NP</code> with 
        <code>P</code>, the number of raster points.
      </para>
      <para>
        Special rules apply if a rasterisation happens on a regular grid of size 
        <code>xraster, yraster</code>. Then the variables varied in the rasterisation will be 
        of dimensions <code>xraster, yraster</code> and the detector data of dimensions 
    		<code>xraster, yraster, (orginal dimensions)</code> 
    		of the detector. For example, an area detector of 
        size <code>xsize, ysize</code> then is stored with
        dimensions <code>xraster, yraster, xsize, ysize</code>. 
        <note>
			<para>Comment: This special rule has problems 
			if the experiment is aborted on the fly or 
			dimensions changed on the way.
			Shall this rule be removed?
			</para>
		</note>
      </para>
      </section>
    </section>
</section>
